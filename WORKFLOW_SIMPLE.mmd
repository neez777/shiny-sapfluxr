%% Simplified Shiny-sapfluxr Workflow
%% Main path: Upload → Calculate → Correct → Calibrate → Export

graph LR
    subgraph "Tab 1: Upload"
        A[Upload Heat Pulse Data] --> B[Upload Wood Properties]
        B --> C[Upload Weather optional]
    end

    subgraph "Tab 2: Configure"
        C --> D[Configure Probe<br/>& Wood Properties]
    end

    subgraph "Tab 3: Calculate"
        D --> E[Select HPV Methods<br/>HRM, MHR, HRMXb, etc.]
        E --> F[Calculate Velocities<br/>Vh_cm_hr]
    end

    subgraph "Tab 4: Visualize Raw"
        F --> G[Interactive Plots<br/>Identify Issues]
    end

    subgraph "Tab 5a: Spacing Correction"
        G --> H[Choose Method:<br/>PELT / Manual / VPD / Heartwood]
        H --> I[Apply Spacing Correction<br/>Burgess method]
    end

    subgraph "Tab 5b: Wound Correction"
        I --> J[Add Reinstallation Dates]
        J --> K[Apply Wound Correction<br/>Vc_cm_hr]
    end

    subgraph "Tab 6: Calibration & sDMA NEW"
        K --> L[Select Primary Method<br/>usually HRM]
        L --> M[Select Secondary Methods<br/>to calibrate]
        M --> N[Enable sDMA?<br/>auto-switch based on Pe]
        N --> O[Apply Calibration & sDMA]
    end

    subgraph "Tab 7: Visualize Final"
        O --> P[View Final Data<br/>with sDMA methods]
    end

    subgraph "Future: Flux Density"
        P --> Q[Calculate Flux Density<br/>kg/m²/hr]
        Q --> R[Tree Water Use<br/>L/day]
    end

    subgraph "Code Export"
        O -.-> S[Generate R Script]
        S -.-> T[Download /<br/>Copy Code]
    end

    %% Styling
    classDef phaseUpload fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef phaseCalc fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef phaseCorrect fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef phaseCalib fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef phaseVis fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef phaseCode fill:#e0f2f1,stroke:#00897b,stroke-width:2px

    class A,B,C,D phaseUpload
    class E,F phaseCalc
    class H,I,J,K phaseCorrect
    class L,M,N,O phaseCalib
    class G,P phaseVis
    class Q,R phaseFuture
    class S,T phaseCode
